<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š æŠ•èµ„å›æµ‹ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/backtest_style.css">
    
    <!-- Chart.js å¢å¼ºç‰ˆå¤šæºåŠ è½½ç­–ç•¥ -->
    <script>
        console.log('ğŸ” å¼€å§‹Chart.jså¢å¼ºç‰ˆå¤šæºåŠ è½½ç­–ç•¥...');
        
        // Chart.js CDNæºåˆ—è¡¨ï¼ˆä¼˜åŒ–é¡ºåºï¼‰
        const chartJSources = [
            'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js',
            'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js',
            'https://unpkg.com/chart.js@4.4.0/dist/chart.umd.js',
            'https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.0/chart.umd.js'
        ];
        
        let currentSourceIndex = 0;
        let loadAttempts = 0;
        const maxAttempts = 3;
        
        function loadChartJS() {
            return new Promise((resolve, reject) => {
                if (typeof Chart !== 'undefined') {
                    console.log('âœ… Chart.jså·²å­˜åœ¨');
                    window.chartJSReady = true;
                    resolve();
                    return;
                }
                
                if (currentSourceIndex >= chartJSources.length) {
                    if (loadAttempts < maxAttempts) {
                        console.log(`ğŸ”„ ç¬¬ ${loadAttempts + 1} è½®é‡è¯•æ‰€æœ‰æº...`);
                        currentSourceIndex = 0;
                        loadAttempts++;
                        setTimeout(() => {
                            loadChartJS().then(resolve).catch(reject);
                        }, 1000);
                        return;
                    } else {
                        console.error('âŒ æ‰€æœ‰Chart.jsæºéƒ½åŠ è½½å¤±è´¥');
                        window.chartJSReady = false;
                        window.chartJSError = 'æ‰€æœ‰æºéƒ½åŠ è½½å¤±è´¥';
                        reject(new Error('æ‰€æœ‰Chart.jsæºéƒ½åŠ è½½å¤±è´¥'));
                        return;
                    }
                }
                
                const script = document.createElement('script');
                script.src = chartJSources[currentSourceIndex];
                script.crossOrigin = 'anonymous';
                
                console.log(`ğŸ”„ å°è¯•åŠ è½½Chart.jsæº ${currentSourceIndex + 1}/${chartJSources.length} (ç¬¬${loadAttempts + 1}è½®): ${script.src}`);
                
                const timeoutId = setTimeout(() => {
                    console.error(`â° Chart.jsåŠ è½½è¶…æ—¶: ${script.src}`);
                    script.remove();
                    currentSourceIndex++;
                    loadChartJS().then(resolve).catch(reject);
                }, 8000);
                
                script.onload = () => {
                    clearTimeout(timeoutId);
                    
                    // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿Chartå¯¹è±¡å®Œå…¨åˆå§‹åŒ–
                    setTimeout(() => {
                        if (typeof Chart !== 'undefined' && Chart.version) {
                            console.log(`âœ… Chart.jsåŠ è½½æˆåŠŸï¼Œæ¥æº: ${script.src}`);
                            console.log(`ğŸ“Š Chart.jsç‰ˆæœ¬: ${Chart.version}`);
                            window.chartJSReady = true;
                            resolve();
                        } else {
                            console.warn(`âš ï¸ è„šæœ¬åŠ è½½ä½†Chartæœªå®Œå…¨åˆå§‹åŒ–: ${script.src}`);
                            currentSourceIndex++;
                            loadChartJS().then(resolve).catch(reject);
                        }
                    }, 100);
                };
                
                script.onerror = () => {
                    clearTimeout(timeoutId);
                    console.error(`âŒ Chart.jsåŠ è½½å¤±è´¥: ${script.src}`);
                    script.remove();
                    currentSourceIndex++;
                    loadChartJS().then(resolve).catch(reject);
                };
                
                document.head.appendChild(script);
            });
        }
        
        // ç«‹å³å¼€å§‹åŠ è½½
        loadChartJS().then(() => {
            console.log('âœ… Chart.jsæœ€ç»ˆåŠ è½½æˆåŠŸ');
            window.chartJSReady = true;
            // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶é€šçŸ¥é¡µé¢Chart.jså·²å°±ç»ª
            window.dispatchEvent(new CustomEvent('chartJSReady'));
        }).catch(error => {
            console.error('âŒ Chart.jsæœ€ç»ˆåŠ è½½å¤±è´¥:', error);
            window.chartJSReady = false;
            window.chartJSError = error.message;
            // è§¦å‘å¤±è´¥äº‹ä»¶
            window.dispatchEvent(new CustomEvent('chartJSFailed', { detail: error.message }));
        });
    </script>
    
    <script>
        // é¡µé¢åŠ è½½å®Œæˆæ£€æŸ¥å’Œå¢å¼ºçš„çŠ¶æ€ç›‘æ§
        window.addEventListener('load', function() {
            console.log('ğŸ” é¡µé¢åŠ è½½å®Œæˆï¼Œæœ€ç»ˆæ£€æŸ¥Chart.jsçŠ¶æ€...');
            
            if (typeof Chart !== 'undefined') {
                console.log('âœ… Chart.jsæœ€ç»ˆçŠ¶æ€: å·²åŠ è½½');
                console.log('ğŸ“Š Chart.jsç‰ˆæœ¬:', Chart.version || 'æœªçŸ¥');
                console.log('ğŸ¯ Chart.jsæ„é€ å‡½æ•°ç±»å‹:', typeof Chart);
                window.chartJSStatus = 'loaded';
            } else {
                console.log('âŒ Chart.jsæœ€ç»ˆçŠ¶æ€: æœªåŠ è½½');
                window.chartJSStatus = 'failed';
            }
            
            // æ£€æŸ¥Canvasæ”¯æŒ
            try {
                const testCanvas = document.createElement('canvas');
                const ctx = testCanvas.getContext('2d');
                if (ctx && typeof ctx.fillRect === 'function') {
                    console.log('âœ… Canvasæ”¯æŒæ­£å¸¸');
                } else {
                    console.warn('âš ï¸ Canvasæ”¯æŒå¼‚å¸¸');
                }
            } catch (e) {
                console.error('âŒ Canvasä¸æ”¯æŒ:', e);
            }
        });
        
        // ç›‘å¬Chart.jsåŠ è½½äº‹ä»¶
        window.addEventListener('chartJSReady', function() {
            console.log('ğŸ‰ æ”¶åˆ°Chart.jså°±ç»ªäº‹ä»¶');
        });
        
        window.addEventListener('chartJSFailed', function(event) {
            console.warn('âš ï¸ æ”¶åˆ°Chart.jså¤±è´¥äº‹ä»¶:', event.detail);
        });
    </script>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="header">
            <h1>æ™ºèƒ½æŠ•èµ„å›æµ‹ç³»ç»Ÿ</h1>
            <div class="system-info">
                <p>ğŸ¤– é›†æˆå¤šAgentåˆ†æå¼•æ“ï¼ŒåŸºäºæœºå™¨å­¦ä¹ çš„é‡åŒ–æŠ•èµ„å›æµ‹å¹³å°</p>
                <div class="system-status">
                    <span class="status-indicator" id="systemStatus">ç³»ç»Ÿå°±ç»ª</span>
                    <span class="version">v2.0</span>
                </div>
            </div>
        </div>

        <!-- å‚æ•°é…ç½®åŒºåŸŸ -->
        <div class="config-section">
            <h2>ğŸ“ å›æµ‹å‚æ•°é…ç½®</h2>
            
            <!-- è‚¡ç¥¨é€‰æ‹© -->
            <div class="form-group">
                <label for="stockSelect">è‚¡ç¥¨é€‰æ‹©</label>
                <div class="stock-selector">
                    <div class="stock-search">
                        <input type="text" id="companyName" placeholder="è¾“å…¥å…¬å¸åç§°ï¼Œå¦‚ï¼šè´µå·èŒ…å°" value="è´µå·èŒ…å°" />
                        <input type="text" id="stockCode" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œå¦‚ï¼šsh.600519" value="sh.600519" />
                    </div>
                    <div class="quick-select">
                        <label>ğŸ’¡ å¿«é€Ÿé€‰æ‹©ï¼š</label>
                        <div class="stock-chips" id="stockChips">
                            <!-- è‚¡ç¥¨å¿«æ·é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ—¶é—´èŒƒå›´ -->
            <div class="form-row">
                <div class="form-group">
                    <label for="startDate">å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="startDate" value="2024-01-01" />
                </div>
                <div class="form-group">
                    <label for="endDate">ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="endDate" value="2024-04-01" />
                </div>
            </div>

            <!-- å›æµ‹é…ç½® -->
            <div class="form-row">
                <div class="form-group">
                    <label for="initialCapital">åˆå§‹èµ„é‡‘ (å…ƒ)</label>
                    <input type="number" id="initialCapital" value="100000" min="10000" step="1000" />
                </div>
                <div class="form-group">
                    <label for="frequency">å†³ç­–é¢‘ç‡</label>
                    <select id="frequency">
                        <option value="daily">æ¯æ—¥å†³ç­– (âš ï¸è€—æ—¶è¾ƒé•¿)</option>
                        <option value="weekly" selected>æ¯å‘¨å†³ç­– â­æ¨èå¿«é€Ÿ</option>
                        <option value="monthly">æ¯æœˆå†³ç­– (âš¡è¶…å¿«é€Ÿ)</option>
                    </select>
                </div>
            </div>

            <!-- å‚æ•°å»ºè®®æç¤º -->
            <div class="tips-section">
                <h3>âš¡ å¿«é€Ÿå›æµ‹å»ºè®® (å‡å°‘ç­‰å¾…æ—¶é—´)</h3>
                <div class="tips-grid">
                    <div class="tip-item">
                        <span class="tip-icon">â°</span>
                        <div class="tip-content">
                            <strong>å¿«é€Ÿæ¨¡å¼</strong>
                            <p>3ä¸ªæœˆ + æ¯å‘¨å†³ç­– = 12ä¸ªå†³ç­–ç‚¹</p>
                            <small>é¢„è®¡è€—æ—¶ï¼š5-8åˆ†é’Ÿ</small>
                        </div>
                    </div>
                    <div class="tip-item">
                        <span class="tip-icon">ğŸš€</span>
                        <div class="tip-content">
                            <strong>è¶…å¿«æ¨¡å¼</strong>
                            <p>3ä¸ªæœˆ + æ¯æœˆå†³ç­– = 3ä¸ªå†³ç­–ç‚¹</p>
                            <small>é¢„è®¡è€—æ—¶ï¼š2-3åˆ†é’Ÿ</small>
                        </div>
                    </div>
                    <div class="tip-item">
                        <span class="tip-icon">âš ï¸</span>
                        <div class="tip-content">
                            <strong>é¿å…æ¯æ—¥å†³ç­–</strong>
                            <p>4ä¸ªæœˆæ¯æ—¥ = 120ä¸ªå†³ç­–ç‚¹</p>
                            <small>è€—æ—¶ï¼š30-60åˆ†é’Ÿ</small>
                        </div>
                    </div>
                    <div class="tip-item">
                        <span class="tip-icon">ğŸ’¡</span>
                        <div class="tip-content">
                            <strong>æ¨èé…ç½®</strong>
                            <p>æ¯å‘¨å†³ç­–å¯è·å¾—ä¸°å¯Œçš„äº¤æ˜“è¡Œä¸º</p>
                            <small>å¹³è¡¡é€Ÿåº¦ä¸åˆ†ææ·±åº¦</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="action-buttons">
                <button type="button" id="startBacktestBtn" onclick="startBacktest()" class="primary-btn">
                    <span class="btn-icon">ğŸš€</span>
                    <span class="btn-text">å¼€å§‹å›æµ‹</span>
                </button>
                <button type="button" id="stopBacktestBtn" onclick="stopBacktest()" class="secondary-btn" disabled>
                    <span class="btn-icon">â¹ï¸</span>
                    <span class="btn-text">åœæ­¢å›æµ‹</span>
                </button>
                <button type="button" id="resetBtn" onclick="resetForm()" class="tertiary-btn">
                    <span class="btn-icon">ğŸ”„</span>
                    <span class="btn-text">é‡ç½®å‚æ•°</span>
                </button>
            </div>
        </div>

        <!-- å›æµ‹è¿›åº¦ -->
        <div class="progress-section" id="progressSection" style="display: none;">
            <h2>â³ å›æµ‹è¿›åº¦</h2>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                    <span class="progress-text" id="progressText">0%</span>
                </div>
                <div class="progress-message" id="progressMessage">ç­‰å¾…å¼€å§‹...</div>
            </div>
        </div>

        <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
        <div class="results-section" id="resultsSection" style="display: none;">
            <h2>ğŸ“ˆ å›æµ‹ç»“æœ</h2>
            
            <!-- å…³é”®æŒ‡æ ‡ -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-icon">ğŸ’°</div>
                    <div class="metric-content">
                        <h3>æ€»æ”¶ç›Š</h3>
                        <div class="metric-value" id="totalProfit">Â¥0</div>
                        <div class="metric-change" id="totalReturn">0%</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">ğŸ“Š</div>
                    <div class="metric-content">
                        <h3>æœ€å¤§å›æ’¤</h3>
                        <div class="metric-value" id="maxDrawdown">0%</div>
                        <div class="metric-sub">é£é™©æ§åˆ¶æŒ‡æ ‡</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">âš¡</div>
                    <div class="metric-content">
                        <h3>å¤æ™®æ¯”ç‡</h3>
                        <div class="metric-value" id="sharpeRatio">0.00</div>
                        <div class="metric-sub">é£é™©è°ƒæ•´æ”¶ç›Š</div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">ğŸ”„</div>
                    <div class="metric-content">
                        <h3>äº¤æ˜“æ¬¡æ•°</h3>
                        <div class="metric-value" id="totalTrades">0</div>
                        <div class="metric-sub" id="winningTrades">èƒœç‡: 0%</div>
                    </div>
                </div>
            </div>

            <!-- å›¾è¡¨å±•ç¤º -->
            <div class="charts-container">
                <div class="chart-section">
                    <h3>ğŸ“ˆ èµ„äº§ä»·å€¼èµ°åŠ¿</h3>
                    <div class="chart-wrapper">
                        <canvas id="valueChart"></canvas>
                    </div>
                </div>
                <div class="chart-section">
                    <h3>ğŸ“Š æ”¶ç›Šåˆ†å¸ƒ</h3>
                    <div class="chart-wrapper">
                        <canvas id="returnsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- äº¤æ˜“è®°å½• -->
            <div class="transactions-section">
                <h3>ğŸ“‹ äº¤æ˜“è®°å½•</h3>
                <div class="table-container">
                    <table id="transactionsTable">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>æ“ä½œ</th>
                                <th>è‚¡æ•°</th>
                                <th>ä»·æ ¼</th>
                                <th>é‡‘é¢</th>
                                <th>ä¿¡å¿ƒåº¦</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- äº¤æ˜“è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ä¸‹è½½æŒ‰é’® -->
            <div class="download-section">
                <button type="button" onclick="downloadResults()" class="download-btn">
                    <span class="btn-icon">ğŸ“¥</span>
                    <span class="btn-text">ä¸‹è½½è¯¦ç»†æŠ¥å‘Š</span>
                </button>
            </div>
        </div>
    </div>

    <!-- æç¤ºæ¶ˆæ¯ -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="/static/backtest_script.js"></script>
</body>
</html> 